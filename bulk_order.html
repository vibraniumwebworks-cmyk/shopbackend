<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trichy Sweets | Bulk Order System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --primary: #6b46c1; --primary-dark: #553c9a; --secondary: #2D3748; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; color: var(--secondary); height: 100vh; overflow: hidden; background-color: #333; }
        #bgVideo { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -100; object-fit: cover; }
        .video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: -99; }
        .hide { display: none !important; } .show-flex { display: flex !important; }
        .app-container { display: grid; height: 100vh; grid-template-columns: 1fr 450px; }
        .products-section { padding: 25px; overflow-y: auto; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; border-radius: 15px; background: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 15px rgba(0,0,0,0.05); gap:20px; flex-wrap: wrap;}
        h1 { font-family: 'Poppins', sans-serif; font-size: 1.8rem; color: var(--primary); white-space: nowrap; }

        .search-container { flex-grow: 1; max-width: 400px; position: relative; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 30px; border: 2px solid #e2e8f0; outline: none; font-size: 1rem; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.2); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #a0aec0; }

        .category-title { font-family: 'Poppins', sans-serif; font-size: 1.5rem; color: white; margin: 30px 0 15px 0; border-bottom: 3px solid var(--primary); display: inline-block; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .product-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 15px; text-align: center; transition: 0.3s; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(107, 70, 193, 0.2); }
        .product-card img { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-bottom: 10px; border: 3px solid #f7fafc; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 8px 0; border-radius: 50px; font-weight: 600; width: 100%; margin-top: 10px; cursor: pointer;}
        
        .billing-section { background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; padding: 25px; border-left: 1px solid #e2e8f0; height: 100%; overflow: hidden; }
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; outline: none; font-size: 1rem; }
        .bill-items { flex-grow: 1; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 10px; margin: 15px 0; border: 1px solid #edf2f7; min-height: 0; }
        .bill-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.9rem; }
        .totals-area { background: #F3EFFF; padding: 20px; border-radius: 12px; border: 1px solid #D6BCFA; flex-shrink: 0; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; align-items: center; }
        .grand-total { font-size: 1.3rem; color: var(--primary); font-weight: 800; border-top: 1px dashed #B794F4; padding-top: 10px; }
        .due-amount { font-size: 1.2rem; color: #E53E3E; font-weight: 800; }
        .action-btn { width: 100%; padding: 15px; background: #25D366; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 15px; }
        .back-btn { padding:8px 15px; background:var(--secondary); color:white; border:none; border-radius:5px; cursor:pointer; margin-right:10px; }
        .custom-btn { padding:8px 15px; background:#4A5568; color:white; border:none; border-radius:5px; cursor:pointer; margin-right:10px; }
        .admin-btn { padding:8px 15px; background:#2b6cb0; color:white; border:none; border-radius:5px; cursor:pointer; margin-right:10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .weight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .weight-btn { padding: 12px; border: 2px solid #edf2f7; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--secondary); }
        .weight-btn.active, .weight-btn:hover { border-color: var(--primary); background: #F3EFFF; color: var(--primary); }
        .pack-input-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; background: #f7fafc; padding: 15px; border-radius: 10px; }
    </style>
</head>
<body>

    <video autoplay muted loop id="bgVideo">
        <source src="video1.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <div id="itemModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="mName" style="color:var(--primary); font-size:1.5rem;">Product Name</h3>
            <p style="color:#718096; margin-bottom:5px;">Base Price: ‚Çπ<span id="mPrice">0</span> / kg</p>
            <p id="modalProdTax" style="font-size:0.8rem; background:#eee; display:inline-block; padding:2px 5px; border-radius:4px; margin-bottom:15px;">GST: 5%</p>
            
            <div id="weightSection">
                <div style="margin-top:20px; text-align:left; font-weight:bold; font-size:0.9rem;">1. Select Weight per Pack:</div>
                <div class="weight-grid" id="weightGrid">
                    <button class="weight-btn" onclick="selectWeight(100, this)">100g</button>
                    <button class="weight-btn" onclick="selectWeight(250, this)">250g</button>
                    <button class="weight-btn" onclick="selectWeight(500, this)">500g</button>
                    <button class="weight-btn" onclick="selectWeight(1000, this)">1 Kg</button>
                </div>
                <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                    <input type="number" id="customGrams" placeholder="Custom Grams (Min 1000)" class="input-field" style="margin-bottom:10px;">
                    <button class="weight-btn" style="width:100%; border-color:var(--primary); color:var(--primary);" onclick="selectWeight('custom', this)">Set Custom Weight</button>
                </div>
            </div>

            <div style="text-align:left; font-weight:bold; font-size:0.9rem; margin-bottom:5px; margin-top:20px;">2. How many Packs?</div>
            <div class="pack-input-container">
                <span style="font-size:1.2rem;">üì¶</span>
                <input type="number" id="packCount" value="1" min="1" class="input-field" style="width:100px; text-align:center; font-weight:bold; font-size:1.2rem;">
                <span style="font-weight:bold; color:var(--secondary);">Packs</span>
            </div>
            
            <button class="add-btn" style="padding:15px; font-size:1.1rem;" onclick="addToCart()">Add to Bulk Order</button>
            <button style="margin-top:15px; background:none; border:none; color:red; cursor:pointer; text-decoration:underline;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <div id="customItemModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--secondary); margin-bottom:15px;">‚ûï Add Open Item</h3>
            <input type="text" id="cName" class="input-field" placeholder="Item Name" style="margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="number" id="cPrice" class="input-field" placeholder="Price">
                <select id="cUnit" class="input-field">
                    <option value="kg">Per Kg</option>
                    <option value="pc">Per Pc</option>
                </select>
            </div>
            <input type="number" id="cQty" class="input-field" placeholder="Qty (Count or Grams)" style="margin-bottom:10px;">
            <button class="add-btn" onclick="addCustomToCart()">Add to Bill</button>
            <button style="margin-top:15px; background:none; border:none; color:red; cursor:pointer; text-decoration:underline;" onclick="closeCustomModal()">Cancel</button>
        </div>
    </div>

    <div class="app-container">
        <main class="products-section">
            <div class="header-bar">
                <div style="display:flex; align-items:center;">
                    <h1>üì¶ Bulk</h1>
                    <div class="search-container" style="margin-left:20px;">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchBar" class="search-input" placeholder="Search..." onkeyup="filterCatalog()">
                    </div>
                </div>
                <div>
                    <button class="custom-btn" onclick="openCustomModal()">‚ûï Custom</button>
                    <button class="admin-btn" style="background:#805ad5;" onclick="window.location.href='manage_items.html'">‚öôÔ∏è Items</button>
                    <button class="admin-btn" onclick="window.location.href='admin.html'">üìä Admin</button>
                    <button class="back-btn" onclick="window.location.href='index.html'">‚¨Ö Retail</button>
                </div>
            </div>
            <div id="catalog">
                 <div style="text-align:center; color:white; margin-top:50px;">Loading Products...</div>
            </div>
        </main>

        <aside class="billing-section">
            <h2 style="color:var(--primary); margin-bottom:20px;">üìÑ Invoice Details</h2>
            <div class="input-group"><input type="text" id="custName" class="input-field" placeholder="Organization Name"></div>
            <div class="input-group"><input type="text" id="custAddress" class="input-field" placeholder="Organization Address"></div>
            <div class="input-group"><input type="tel" id="custPhone" class="input-field" placeholder="WhatsApp Number (+91)"></div>

            <div class="bill-items" id="cartList"><div style="text-align:center; padding:30px; color:#a0aec0;">No items</div></div>

            <div class="totals-area">
                <div class="total-row"><span>Subtotal:</span><span>‚Çπ<span id="subtotal">0.00</span></span></div>
                
                <div class="total-row">
                    <span>Discount (%):</span>
                    <input type="number" id="discPer" value="0" style="width:70px; padding:5px; border:1px solid #ccc; text-align:right; border-radius:5px;" onchange="calcTotals()">
                </div>
                <div class="total-row">
                    <span>Discount (‚Çπ):</span>
                    <input type="number" id="discAmt" value="0" style="width:70px; padding:5px; border:1px solid #ccc; text-align:right; border-radius:5px;" onchange="calcTotals()">
                </div>
                <div class="total-row grand-total"><span>Total Bill:</span><span>‚Çπ<span id="total">0.00</span></span></div>
                <div style="margin:15px 0; border-top:1px solid #D6BCFA;"></div>
                <div class="total-row" style="align-items:center;">
                    <span style="font-weight:bold;">Advance Paid:</span>
                    <input type="number" id="advance" value="0" style="width:100px; padding:8px; border:2px solid var(--primary); border-radius:5px; text-align:right; font-weight:bold;" onchange="calcTotals()">
                </div>
                <div class="total-row due-amount"><span>Balance Due:</span><span>‚Çπ<span id="due">0.00</span></span></div>
            </div>
            <button class="action-btn" onclick="generateBill()">üñ®Ô∏è PDF & WhatsApp</button>
        </aside>
    </div>

   <script>
    // ‚úÖ UPDATED BACKEND URL
    const BACKEND_URL = "https://shopbackend-v43a.onrender.com"; 
    
    let products = [];
    let cart = [];
    let currentItem = null;
    let selectedWeight = 0;

    window.onload = function() {
        fetchProducts();
    };

    async function fetchProducts() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/products`);
            products = await response.json();
            
            if(products.length === 0) {
                 document.getElementById('catalog').innerHTML = `<div style="text-align:center; color:white; margin-top:50px;">No items found.</div>`;
            } else {
                renderCatalog(products);
            }
        } catch (error) {
            document.getElementById('catalog').innerHTML = "Error connecting to Render server.";
        }
    }

    function renderCatalog(list) {
        const container = document.getElementById('catalog');
        let html = '<div class="products-grid">';
        
        list.forEach(p => {
            const imgUrl = p.image.startsWith('/uploads') ? `${BACKEND_URL}${p.image}` : p.image;
            html += `
            <div class="product-card" onclick="openModal(${p.id})">
                <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/100'">
                <h4>${p.name}</h4>
                <div style="color:var(--primary); font-weight:bold;">‚Çπ${p.price}/${(p.unit === 'kg') ? 'kg' : 'pc'}</div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }
    
    function filterCatalog() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        const matches = products.filter(p => p.name.toLowerCase().includes(query));
        renderCatalog(matches);
    }

    function openModal(id) {
        currentItem = products.find(p => p.id === id);
        document.getElementById('itemModal').classList.add('show-flex');
        document.getElementById('mName').innerText = currentItem.name;
        document.getElementById('mPrice').innerText = currentItem.price;
        
        selectedWeight = 0;
        document.getElementById('packCount').value = 1;
        document.querySelectorAll('.weight-btn').forEach(b => b.classList.remove('active'));
    }

    function closeModal() { document.getElementById('itemModal').classList.remove('show-flex'); }
    function openCustomModal() { document.getElementById('customItemModal').classList.add('show-flex'); }
    function closeCustomModal() { document.getElementById('customItemModal').classList.remove('show-flex'); }

    function selectWeight(weight, btn) {
        if(weight === 'custom') {
            selectedWeight = parseFloat(document.getElementById('customGrams').value);
        } else {
            selectedWeight = weight;
        }
        document.querySelectorAll('.weight-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function addToCart() {
        if(!selectedWeight || selectedWeight <= 0) return alert("Select Weight");
        const packs = parseInt(document.getElementById('packCount').value);
        if(!packs || packs < 1) return alert("Invalid Packs");

        const weightInKg = selectedWeight / 1000;
        const packPrice = currentItem.price * weightInKg;
        const finalTotal = packPrice * packs;

        cart.push({
            id: currentItem.id,
            name: currentItem.name,
            weight: selectedWeight,
            packs: packs,
            unitPrice: packPrice,
            totalPrice: finalTotal,
            type: 'pack'
        });
        
        closeModal();
        renderCart();
    }

    function addCustomToCart() {
        const name = document.getElementById('cName').value;
        const price = parseFloat(document.getElementById('cPrice').value);
        const qty = parseFloat(document.getElementById('cQty').value);
        
        if(!name || !price || !qty) return alert("Fill all fields");

        cart.push({
            id: 'custom',
            name: name,
            weight: qty, 
            packs: 1,
            unitPrice: price, 
            totalPrice: price * qty, 
            type: 'custom'
        });
        closeCustomModal();
        renderCart();
    }

    function renderCart() {
        const list = document.getElementById('cartList');
        if(cart.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:30px; color:#a0aec0;">No items</div>';
            calcTotals();
            return;
        }
        
        let html = '';
        cart.forEach((item, index) => {
            const detail = item.type === 'pack' 
                ? `${item.packs} x ${item.weight}g Packs` 
                : `${item.weight} qty`;

            html += `
            <div class="bill-row">
                <div>
                    <div style="font-weight:600;">${item.name}</div>
                    <div class="bill-row-details">${detail}</div>
                </div>
                <div style="text-align:right;">
                    <div>‚Çπ${item.totalPrice.toFixed(2)}</div>
                    <button onclick="removeItem(${index})" style="color:red; background:none; border:none; font-size:0.8rem; cursor:pointer;">Remove</button>
                </div>
            </div>`;
        });
        list.innerHTML = html;
        calcTotals();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function calcTotals() {
        const subtotal = cart.reduce((acc, item) => acc + item.totalPrice, 0);
        document.getElementById('subtotal').innerText = subtotal.toFixed(2);
        
        const discPer = parseFloat(document.getElementById('discPer').value) || 0;
        const discAmt = parseFloat(document.getElementById('discAmt').value) || 0;
        
        let total = subtotal;
        if(discPer > 0) total -= (total * discPer / 100);
        if(discAmt > 0) total -= discAmt;
        
        document.getElementById('total').innerText = total.toFixed(2);

        const advance = parseFloat(document.getElementById('advance').value) || 0;
        const due = total - advance;
        document.getElementById('due').innerText = due.toFixed(2);
    }

    async function generateBill() {
        if(cart.length === 0) return alert("Cart is empty");
        
        // ‚úÖ CHECK IF PDF LIB LOADED
        if(!window.jspdf) return alert("Error: PDF Library not loaded.");

        const btn = document.querySelector('.action-btn');
        btn.innerText = "‚è≥ Saving Order...";
        btn.disabled = true;

        const totalAmount = parseFloat(document.getElementById('total').innerText);
        const paidAmount = parseFloat(document.getElementById('advance').value) || 0;
        const dueAmount = parseFloat(document.getElementById('due').innerText);

        const orderData = {
            customer_name: document.getElementById('custName').value || "Bulk Customer",
            customer_phone: document.getElementById('custPhone').value || "",
            customer_address: document.getElementById('custAddress').value || "",
            items: cart,
            total_amount: totalAmount,
            paid_amount: paidAmount,
            due_amount: dueAmount,
            order_type: "Bulk"
        };

        try {
            // ‚úÖ SAVE TO BACKEND
            const response = await fetch(`${BACKEND_URL}/api/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if(!response.ok) throw new Error("Server error");
            const resData = await response.json();

            // ‚úÖ CREATE PDF
            createPDF(orderData, resData.orderId);

            alert("‚úÖ Order Saved & PDF Generated!");
            
            cart = []; renderCart();
            document.getElementById('custName').value = '';
            document.getElementById('custPhone').value = '';
            document.getElementById('custAddress').value = '';
            document.getElementById('advance').value = 0;

        } catch (error) {
            console.error(error);
            alert("‚ùå Failed to save order. Check connection.");
        } finally {
            btn.innerText = "üñ®Ô∏è PDF & WhatsApp";
            btn.disabled = false;
        }
    }

    function createPDF(order, orderId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ format: 'a4', unit: 'mm' });

        doc.setFont("helvetica", "bold"); doc.setFontSize(22);
        doc.text("TRICHY SWEETS - BULK ORDER", 105, 20, { align: "center" });
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text("Main Road, Trichy | Ph: 9087151295", 105, 26, { align: "center" });
        doc.line(10, 30, 200, 30);

        let y = 40;
        doc.setFontSize(12);
        doc.text(`Invoice #: BULK-${orderId}`, 15, y);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, y);
        y+=8;
        doc.text(`To: ${order.customer_name}`, 15, y);
        y+=8;
        if(order.customer_address) {
            doc.text(`Addr: ${order.customer_address}`, 15, y);
            y+=8;
        }

        y+=10;
        doc.setFillColor(230,230,230);
        doc.rect(15, y, 180, 10, 'F');
        doc.setFont("helvetica", "bold");
        doc.text("Item Description", 20, y+7);
        doc.text("Price", 160, y+7);

        y+=15;
        doc.setFont("helvetica", "normal");
        order.items.forEach(item => {
            const desc = item.type === 'pack' 
                ? `${item.name} (${item.packs} x ${item.weight}g)` 
                : `${item.name} (Qty: ${item.weight})`;
            
            doc.text(desc, 20, y);
            doc.text(item.totalPrice.toFixed(2), 160, y);
            y+=8;
        });

        y+=5;
        doc.line(15, y, 195, y);
        y+=10;
        
        doc.setFont("helvetica", "bold");
        doc.text(`Total Amount:`, 120, y);
        doc.text(order.total_amount.toFixed(2), 180, y, {align:'right'}); y+=8;

        doc.text(`Advance Paid:`, 120, y);
        doc.text(order.paid_amount.toFixed(2), 180, y, {align:'right'}); y+=8;

        doc.setTextColor(200, 0, 0); // Red
        doc.text(`Balance Due:`, 120, y);
        doc.text(order.due_amount.toFixed(2), 180, y, {align:'right'}); 

        doc.save(`BulkInvoice_${order.customer_name}.pdf`);

        if(order.customer_phone) {
            const msg = `Hello ${order.customer_name}, Your Bulk Order #${orderId} is confirmed.\nTotal: Rs.${order.total_amount}\nAdvance: Rs.${order.paid_amount}\n*Balance Due: Rs.${order.due_amount}*`;
            window.open(`https://wa.me/${order.customer_phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    }
</script>
</body>
</html>
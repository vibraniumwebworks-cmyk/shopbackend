<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f7fafc; padding: 20px; }
        .nav-bar { display:flex; justify-content:space-between; margin-bottom:20px; background:white; padding:20px; border-radius:10px; }
        .stats { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:20px; }
        .card { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; }
        th, td { padding:15px; text-align:left; border-bottom:1px solid #eee; }
        .status-due { color:red; font-weight:bold; }
        .status-paid { color:green; font-weight:bold; }
        .btn { padding:5px 10px; cursor:pointer; background:#2b6cb0; color:white; border:none; border-radius:5px; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:30px; width:300px; text-align:center; border-radius:10px; }
    </style>
</head>
<body>
    <div class="nav-bar">
        <h2>ðŸ“Š Admin Dashboard</h2>
        <div>
            <a href="index.html" class="btn">Retail POS</a>
            <a href="bulk_order.html" class="btn">Bulk POS</a>
        </div>
    </div>

    <div class="stats">
        <div class="card"><h3>Total Revenue</h3><h2 id="rev">â‚¹0</h2></div>
        <div class="card"><h3>Pending Due</h3><h2 id="due" style="color:red;">â‚¹0</h2></div>
        <div class="card"><h3>Orders</h3><h2 id="cnt">0</h2></div>
    </div>

    <table id="orderTable">
        <thead><tr><th>Date</th><th>Customer</th><th>Type</th><th>Total</th><th>Paid</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="payModal" class="modal">
        <div class="modal-content">
            <h3>Pay Balance</h3>
            <p>Due: â‚¹<span id="mDue">0</span></p>
            <input type="number" id="payAmt" placeholder="Amount" style="padding:10px; width:100%; margin:10px 0;">
            <button class="btn" onclick="processPayment()">Confirm</button>
            <button onclick="document.getElementById('payModal').style.display='none'" style="margin-top:10px; border:none; background:none; cursor:pointer; color:red;">Cancel</button>
        </div>
    </div>

    <script>
        // âœ… UPDATED BACKEND URL
        const BACKEND_URL = "https://shopbackend-v43a.onrender.com"; 
        let allOrders = [], currentId = null;

        window.onload = async function() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/orders`);
                allOrders = await res.json();
                renderTable();
            } catch(e) { console.error(e); }
        };

        function renderTable() {
            let html = '', rev = 0, due = 0;
            allOrders.forEach(o => {
                rev += parseFloat(o.paid_amount);
                due += parseFloat(o.due_amount);
                const status = o.due_amount > 0 
                    ? `<span class="status-due">Due: ${o.due_amount}</span>` 
                    : `<span class="status-paid">Paid</span>`;
                const btn = o.due_amount > 0 
                    ? `<button class="btn" onclick="openPay(${o.id})">Pay</button>` 
                    : '-';

                html += `<tr>
                    <td>${new Date(o.order_date).toLocaleDateString()}</td>
                    <td>${o.customer_name}<br><small>${o.customer_phone}</small></td>
                    <td>${o.order_type}</td>
                    <td>â‚¹${o.total_amount}</td>
                    <td>â‚¹${o.paid_amount}</td>
                    <td>${status}</td>
                    <td>${btn}</td>
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = html;
            document.getElementById('rev').innerText = `â‚¹${rev.toFixed(2)}`;
            document.getElementById('due').innerText = `â‚¹${due.toFixed(2)}`;
            document.getElementById('cnt').innerText = allOrders.length;
        }

        function openPay(id) {
            const o = allOrders.find(x => x.id === id);
            currentId = id;
            document.getElementById('mDue').innerText = o.due_amount;
            document.getElementById('payAmt').value = o.due_amount;
            document.getElementById('payModal').style.display = 'flex';
        }

        async function processPayment() {
            const amt = parseFloat(document.getElementById('payAmt').value);
            const order = allOrders.find(x => x.id === currentId);
            
            const newPaid = parseFloat(order.paid_amount) + amt;
            const newDue = parseFloat(order.due_amount) - amt;

            await fetch(`${BACKEND_URL}/api/orders/${currentId}/pay`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ paid_amount: newPaid, due_amount: newDue })
            });

            document.getElementById('payModal').style.display='none';
            location.reload();
        }
    </script>
</body>
</html>
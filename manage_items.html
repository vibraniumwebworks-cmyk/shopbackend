<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Inventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 30px; background: #f4f7f6; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        
        .form-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 20px;}
        .list-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        h2, h3 { color: #2b6cb0; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        input:focus, select:focus { border-color: #2b6cb0; }
        
        button { padding: 12px; background: #2b6cb0; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; transition: 0.2s; }
        button:hover { background: #1a4971; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
        .item-info { display: flex; align-items: center; gap: 15px; }
        .item-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
        
        .btn-group { display: flex; gap: 5px; }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.85rem; }
        .btn-del { background: #e53e3e; } .btn-del:hover { background: #c53030; }
        .btn-edit { background: #d69e2e; } .btn-edit:hover { background: #b7791f; }

        .nav-links { margin-bottom: 20px; text-align: center; }
        .nav-links a { margin: 0 10px; color: #2b6cb0; text-decoration: none; font-weight: 600; }
        
        .error-msg { color: #e53e3e; background: #fff5f5; padding: 10px; border-radius: 5px; border: 1px solid #fed7d7; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="nav-links">
        <a href="index.html">‚¨Ö Go to Retail POS</a>
        <a href="admin.html">üìä Admin Dashboard</a>
    </div>

    <div class="container">
        <div class="form-box">
            <h3 id="formTitle">Add New Item</h3>
            <input type="hidden" id="editId">
            
            <label>Name</label>
            <input type="text" id="pName" placeholder="e.g. Gulab Jamun">
            
            <label>Price (‚Çπ)</label>
            <input type="number" id="pPrice" placeholder="e.g. 600">
            
            <label>Category</label>
            <select id="pCategory">
                <option value="Sweets">Sweets</option>
                <option value="Snacks">Snacks</option>
                <option value="Juices">Juices</option>
            </select>
            
            <label>Unit</label>
            <select id="pUnit">
                <option value="kg">Per Kg</option>
                <option value="pc">Per Piece</option>
            </select>
            
            <label>GST %</label>
            <input type="number" id="pGst" placeholder="e.g. 5" value="5">
            
            <label>Image</label>
            <input type="file" id="pImage" accept="image/*">
            
            <button id="saveBtn" onclick="saveProduct()">üíæ Save Item</button>
            <button onclick="resetForm()" style="background:#718096; margin-top:10px;">‚ùå Cancel</button>
        </div>

        <div class="list-box">
            <h3>Current Inventory</h3>
            <div id="itemList">Loading items...</div>
        </div>
    </div>

    <script>
        // ‚úÖ BACKEND URL
        const BASE_URL = "https://shopbackend-v43a.onrender.com";
        const API_URL = `${BASE_URL}/api/products`; 

        async function loadItems() {
            const list = document.getElementById('itemList');
            try {
                // Fetch data
                const res = await fetch(API_URL);
                
                // If server returns error (e.g. 500 DB Error)
                if(!res.ok) throw new Error(`Server Error: ${res.status} ${res.statusText}`);

                const data = await res.json();
                
                if(data.length === 0) {
                    list.innerHTML = '<p style="color:#777; text-align:center;">No items found. Add one!</p>';
                    return;
                }

                list.innerHTML = data.map(item => {
                    // Fix Image URL for uploads
                    const imgUrl = item.image.startsWith('/uploads') ? `${BASE_URL}${item.image}` : item.image;
                    
                    return `
                    <div class="item-row">
                        <div class="item-info">
                            <img src="${imgUrl}" class="item-img" onerror="this.src='https://via.placeholder.com/50'">
                            <div>
                                <div style="font-weight:600; font-size:1.1rem;">${item.name}</div>
                                <div style="font-size:0.9rem; color:#666;">‚Çπ${item.price} / ${item.unit} | ${item.category}</div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn-sm btn-edit" onclick="editItem(${item.id})">‚úèÔ∏è</button>
                            <button class="btn-sm btn-del" onclick="deleteItem(${item.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
                }).join('');

            } catch(e) {
                console.error(e);
                // ‚úÖ SHOW ACTUAL ERROR ON SCREEN
                list.innerHTML = `
                    <div class="error-msg">
                        <strong>‚ùå Connection Failed!</strong><br>
                        ${e.message}<br><br>
                        <em>Troubleshooting:</em><br>
                        1. <a href="${BASE_URL}" target="_blank">Click here to wake up Server</a>.<br>
                        2. Check Console (F12) for details.<br>
                        3. Database credentials might be expired.
                    </div>
                `;
            }
        }

        async function saveProduct() {
            const submitBtn = document.getElementById('saveBtn');
            const id = document.getElementById('editId').value;
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;

            if(!name || !price) return alert("Please fill Name and Price");

            submitBtn.innerText = "Saving...";
            submitBtn.disabled = true;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('price', price);
            formData.append('category', document.getElementById('pCategory').value);
            formData.append('unit', document.getElementById('pUnit').value);
            formData.append('gst', document.getElementById('pGst').value);
            
            const fileInput = document.getElementById('pImage');
            if(fileInput.files[0]) {
                formData.append('image', fileInput.files[0]);
            }

            let method = 'POST';
            let url = API_URL;

            if(id) {
                method = 'PUT';
                url = `${API_URL}/${id}`;
            }

            try {
                const response = await fetch(url, { method: method, body: formData });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server Error (${response.status}): ${errorText}`);
                }

                const result = await response.json();
                alert("‚úÖ Success: " + (result.message || "Item Saved"));
                
                resetForm();
                loadItems();
                
            } catch (error) {
                console.error("Save Failed:", error);
                alert("‚ùå Failed to save: " + error.message);
            } finally {
                submitBtn.innerText = "üíæ Save Item";
                submitBtn.disabled = false;
            }
        }

        async function deleteItem(id) {
            if(confirm("Are you sure you want to delete this item?")) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                loadItems();
            }
        }

        async function editItem(id) {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const item = data.find(p => p.id === id);
                
                document.getElementById('editId').value = item.id;
                document.getElementById('pName').value = item.name;
                document.getElementById('pPrice').value = item.price;
                document.getElementById('pCategory').value = item.category;
                document.getElementById('pUnit').value = item.unit;
                document.getElementById('pGst').value = item.gst;
                document.getElementById('formTitle').innerText = "Edit Item: " + item.name;
                window.scrollTo(0,0);
            } catch(e) {
                alert("Error fetching item details");
            }
        }

        function resetForm() {
            document.getElementById('editId').value = '';
            document.getElementById('pName').value = '';
            document.getElementById('pPrice').value = '';
            document.getElementById('pImage').value = '';
            document.getElementById('formTitle').innerText = "Add New Item";
        }

        loadItems();
    </script>
</body>
</html>